name: Code Scan Checks

on:
  push:
    branches: [ main, main-local, local-dev ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ main, main-local, local-dev ]
  schedule:
    - cron: '35 10 10 * *'

jobs:
  checks:
    name: SSA Checks
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    -
      name: Checkout repo
      uses: actions/checkout@v3
    -
      name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.20"
        cache: true
    -
      name: Build zk
      run: make build
    -
      name: govulncheck
      continue-on-error: true
      run: |
        set -xue
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck -test ./...
    -
      name: GoKart
      continue-on-error: true
      run: |
        set -xue
        go install github.com/praetorian-inc/gokart@latest
        gokart scan -s -o gokart-results.sarif
    # Upload the SARIF file generated by GoKart
    -
      name: Upload GoKart results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gokart-results.sarif
    # TODO: maybe split these into separate jobs
    -
      name: staticcheck
      uses: dominikh/staticcheck-action@v1.3.0
      continue-on-error: true
      with:
        version: "2022.1.3"
        install-go: false
    -
      name: golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        # Optional: version of golangci-lint to use in form of v1.2 or v1.2.3 or `latest` to use the latest version
        version: v1.50.1
